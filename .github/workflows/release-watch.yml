name: Watch External Project Releases

on:
  schedule:         # æ¯ 30 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    ############## 1. æ‹‰å–ä»“åº“ï¼Œç¡®ä¿ state.json å­˜åœ¨ ################
    - name: Checkout
      uses: actions/checkout@v4

    - name: Ensure state.json
      run: |
        [[ -f state.json ]] || echo '{}' > state.json

    ############## 2. å®‰è£… jq ################
    - name: Install jq
      run: sudo apt-get -qq update && sudo apt-get -qq install -y jq

    ############## 3. è¯»å– repos.txtï¼Œæ£€æŸ¥æœ€æ–° Release ################
    - name: Scan repositories
      id: scan
      run: |
        changed=false
        notice=""
        while IFS= read -r repo || [[ -n "$repo" ]]; do
          [[ -z "$repo" ]] && continue        # å¿½ç•¥ç©ºè¡Œ
          echo "==> $repo"
          api="https://api.github.com/repos/${repo}/releases/latest"
          json=$(curl -sL "$api" -H "Authorization: Bearer ${{ github.token }}")
          tag=$(jq -r '.tag_name // empty' <<< "$json")
          url=$(jq -r '.html_url // empty' <<< "$json")
          if [[ -z "$tag" ]]; then
            echo "   â†³ no releases"; continue
          fi

          last=$(jq -r --arg repo "$repo" '.[$repo] // empty' state.json)
          if [[ "$tag" != "$last" ]]; then
            echo "   â†³ NEW $tag"
            changed=true
            notice="${notice}\nğŸ“¢ ${repo} å‘å¸ƒæ–°ç‰ˆæœ¬ï¼š${tag}\nğŸ‘‰ ${url}\n"
            tmp=$(mktemp)
            jq --arg repo "$repo" --arg tag "$tag" '.[$repo]=$tag' state.json > "$tmp" && mv "$tmp" state.json
          else
            echo "   â†³ up-to-date ($tag)"
          fi
        done < repos.txt
        echo -e "$notice" > notice.txt
        echo "changed=$changed" >> $GITHUB_OUTPUT

    ############## 4. è°ƒç”¨è“ä¿¡ Webhook å‘é€é€šçŸ¥ ################
    - name: Send message to Lanxin
      if: steps.scan.outputs.changed == 'true'
      run: |
        text=$(cat notice.txt)
        payload=$(jq -n --arg txt "$text" \
          '{msgType:"text", msgData:{text:{content:$txt}}}')
        curl -s -X POST '${{ secrets.LANXIN_WEBHOOK }}' \
          -H 'Content-Type: application/json' \
          -d "$payload"

    ############## 5. ä¿å­˜ state.json é˜²æ­¢é‡å¤é€šçŸ¥ ################
    - name: Commit new state
      if: steps.scan.outputs.changed == 'true'
      run: |
        git config user.name release-bot
        git config user.email release-bot@users.noreply.github.com
        git add state.json
        git commit -m "bot: update release state [skip ci]"
        git push
